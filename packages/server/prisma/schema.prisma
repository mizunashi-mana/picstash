// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model Image {
  id                        String                     @id @default(uuid())
  path                      String
  thumbnailPath             String?                    @map("thumbnail_path")
  mimeType                  String                     @map("mime_type")
  size                      Int
  width                     Int?
  height                    Int?
  title                     String                     @default("無題の画像") /// Auto-generated title for accessibility
  description               String?
  embedding                 Bytes?                     /// CLIP embedding vector (512 dimensions, Float32Array)
  embeddedAt                DateTime?                  @map("embedded_at") /// When embedding was generated
  createdAt                 DateTime                   @default(now()) @map("created_at")
  updatedAt                 DateTime                   @updatedAt @map("updated_at")
  attributes                ImageAttribute[]
  collections               CollectionImage[]
  viewHistory               ViewHistory[]
  recommendationConversions RecommendationConversion[]
}

model AttributeLabel {
  id         String           @id @default(uuid())
  name       String           @unique
  color      String?
  embedding  Bytes?           /// CLIP text embedding vector (512 dimensions, Float32Array)
  embeddedAt DateTime?        @map("embedded_at") /// When embedding was generated
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt @map("updated_at")
  attributes ImageAttribute[]
}

model ImageAttribute {
  id        String         @id @default(uuid())
  imageId   String         @map("image_id")
  labelId   String         @map("label_id")
  keywords  String?
  image     Image          @relation(fields: [imageId], references: [id], onDelete: Cascade)
  label     AttributeLabel @relation(fields: [labelId], references: [id], onDelete: Cascade)
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  @@unique([imageId, labelId])
  @@map("image_attribute")
}

model Collection {
  id           String            @id @default(uuid())
  name         String
  description  String?
  coverImageId String?           @map("cover_image_id")
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")
  images       CollectionImage[]
}

model CollectionImage {
  id           String     @id @default(uuid())
  collectionId String     @map("collection_id")
  imageId      String     @map("image_id")
  order        Int        @default(0)
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  image        Image      @relation(fields: [imageId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now()) @map("created_at")

  @@unique([collectionId, imageId])
  @@map("collection_image")
}

model ViewHistory {
  id                       String                     @id @default(uuid())
  imageId                  String                     @map("image_id")
  image                    Image                      @relation(fields: [imageId], references: [id], onDelete: Cascade)
  viewedAt                 DateTime                   @default(now()) @map("viewed_at")
  duration                 Int?                       /// 滞在時間（ミリ秒）
  createdAt                DateTime                   @default(now()) @map("created_at")
  updatedAt                DateTime                   @updatedAt @map("updated_at")
  recommendationConversion RecommendationConversion?

  @@index([imageId])
  @@index([viewedAt])
  @@map("view_history")
}

model RecommendationConversion {
  id                  String       @id @default(uuid())
  imageId             String       @map("image_id")
  image               Image        @relation(fields: [imageId], references: [id], onDelete: Cascade)
  recommendationScore Float        @map("recommendation_score") /// 推薦時のスコア
  impressionAt        DateTime     @map("impression_at") /// 推薦が表示された日時
  clickedAt           DateTime?    @map("clicked_at") /// クリックされた日時（nullならスキップ）
  viewHistoryId       String?      @unique @map("view_history_id") /// クリック時の閲覧履歴への参照
  viewHistory         ViewHistory? @relation(fields: [viewHistoryId], references: [id], onDelete: SetNull)
  createdAt           DateTime     @default(now()) @map("created_at")

  @@index([imageId])
  @@index([impressionAt])
  @@map("recommendation_conversion")
}
