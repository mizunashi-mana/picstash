# Desktop App (デスクトップアプリ化)

## 目標

ブラウザなしでネイティブアプリとして動作させ、Eagle からの移行先として選ばれるプロダクトにする。

### 完了条件

- Windows / macOS / Linux 向けのインストーラが生成される
- ローカルフォルダに画像・DB を保存できる
- 既存の全機能がデスクトップアプリで動作する

## スコープ

### やること

- コアロジックの分離（`@picstash/core` パッケージ作成）
- Tauri によるデスクトップアプリ化
- ストレージ抽象化レイヤーの構築
- ローカルファイルシステムへの保存対応

### やらないこと

- クラウド同期機能（Phase 6 で対応）
- モバイルアプリ対応（Phase 7 で対応）
- ブラウザ拡張との連携（Phase 4 で対応）
- ファイル監視・自動インポート機能（Phase 1-4 で対応予定）
- Ollama 連携（将来の拡張）
- オフラインモード切り替え UI（将来の拡張）

## タスク分解

| ID | タスク | 依存 | 優先度 | 状態 |
|----|--------|------|--------|------|
| T0 | コアロジックの分離（@picstash/core） | - | 最高 | 未着手 |
| T1 | Tauri プロジェクトセットアップ | - | 高 | 未着手 |
| T2 | 既存 Web アプリの Tauri 組み込み | T0, T1 | 高 | 未着手 |
| T3 | ストレージインターフェース定義 | T0 | 高 | 未着手 |
| T4 | Tauri コマンドによるファイルシステムアクセス | T1, T3 | 高 | 未着手 |
| T5 | ローカルファイルシステムアダプタ実装 | T4 | 高 | 未着手 |
| T6 | SQLite データベースのローカル配置 | T5 | 中 | 未着手 |
| T7 | インストーラ生成・配布設定 | T2 | 中 | 未着手 |

### 依存関係図

```
T0 (コアロジック分離)
 │
 ├──────────────────────┐
 │                      ↓
 │    T1 ──────────→ T2 → T7
 │     │              ↑
 │     ↓              │
 └──→ T3 → T4 → T5 → T6
```

### 各タスクの詳細

#### T0: コアロジックの分離（@picstash/core）

- 概要: `@picstash/server` からコアビジネスロジックを `@picstash/core` パッケージに分離し、Web 版と Desktop 版で共通利用できるようにする
- 完了条件:
  - `packages/core` ディレクトリに新パッケージが作成される
  - リポジトリ層（ImageRepository, CollectionRepository 等）が分離される
  - サービス層（画像処理、AI 解析等）が分離される
  - `@picstash/server` は HTTP ルーティングとプラグインのみを保持
  - 既存のテストが全て通る
- 分離対象:
  - `domain/` - エンティティ、値オブジェクト
  - `repository/` - データアクセス層
  - `service/` - ビジネスロジック
  - `infra/database/` - Prisma クライアント、DB 接続
  - `infra/storage/` - ファイルストレージ
  - `infra/ai/` - AI 処理（埋め込み生成、キャプション等）
  - `infra/di/` - DI コンテナ
- 残留対象（@picstash/server）:
  - `infra/http/` - Fastify ルート、プラグイン
  - HTTP 固有のリクエスト/レスポンス処理

#### T1: Tauri プロジェクトセットアップ

- 概要: Tauri v2 をプロジェクトに導入し、基本的なビルド環境を構築する
- 完了条件:
  - `packages/desktop-app` ディレクトリに Tauri プロジェクトが作成される
  - `npm run tauri dev` で空のウィンドウが起動する
  - Tauri CLI がモノレポと統合される

#### T2: 既存 Web アプリの Tauri 組み込み

- 概要: 既存の React フロントエンドを Tauri のウェブビューに組み込み、`@picstash/core` と連携させる
- 完了条件:
  - Vite のビルド出力が Tauri に正しく読み込まれる
  - 開発モードでホットリロードが動作する
  - 本番ビルドでアプリが正常に動作する
  - `@picstash/core` の機能が Tauri 経由で利用できる
- 依存理由: T0 でコアロジック分離、T1 で Tauri 環境が必要

#### T3: ストレージインターフェース定義

- 概要: ローカル/クラウドストレージを抽象化するインターフェースを `@picstash/core` に定義する
- 完了条件:
  - `StorageAdapter` インターフェースが定義される
  - 画像の保存/読み取り/削除操作が抽象化される
  - サムネイル生成のフローが定義される
- 依存理由: T0 でコアパッケージが存在している必要がある

#### T4: Tauri コマンドによるファイルシステムアクセス

- 概要: Rust 側でファイルシステム操作の Tauri コマンドを実装する
- 完了条件:
  - ファイル読み書き用の Tauri コマンドが実装される
  - フロントエンドから `invoke` で呼び出せる
  - 適切なパーミッション設定がされる
- 依存理由: T1 で Tauri 環境、T3 でインターフェース設計が必要

#### T5: ローカルファイルシステムアダプタ実装

- 概要: `StorageAdapter` のローカル実装を作成する
- 完了条件:
  - 指定フォルダへの画像保存が動作する
  - サムネイル生成・保存が動作する
  - 既存の API との互換性が保たれる
- 依存理由: T4 で Tauri コマンドが実装されている必要がある

#### T6: SQLite データベースのローカル配置

- 概要: SQLite データベースをアプリのデータディレクトリに配置する
- 完了条件:
  - DB ファイルがユーザーデータディレクトリに保存される
  - アプリ起動時に自動でマイグレーションが実行される
  - 既存データの移行パスが用意される
- 依存理由: T5 でローカルストレージの基盤が必要

#### T7: インストーラ生成・配布設定

- 概要: 各 OS 向けのインストーラを生成する CI/CD を構築する
- 完了条件:
  - Windows: NSIS/WiX インストーラが生成される
  - macOS: DMG / pkg が生成される
  - Linux: AppImage / deb が生成される
  - GitHub Releases で配布できる
- 依存理由: T2 でアプリが動作している必要がある

## 技術選定

### Tauri v2

- Rust ベースのデスクトップアプリフレームワーク
- Electron より軽量（バンドルサイズ、メモリ使用量）
- ネイティブ WebView を使用（OS 標準のレンダリングエンジン）
- ファイルシステムアクセス、システムトレイ、通知などの OS 機能にアクセス可能

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────┐
│                         パッケージ構成                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    @picstash/core                            │   │
│  │  ─────────────────────────────────────────────────────────   │   │
│  │  domain/      - エンティティ、値オブジェクト                   │   │
│  │  repository/  - データアクセス層                              │   │
│  │  service/     - ビジネスロジック                              │   │
│  │  infra/       - DB, Storage, AI, DI                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                    ↑                        ↑                       │
│                    │                        │                       │
│  ┌─────────────────┴───────┐  ┌─────────────┴───────────────────┐  │
│  │    @picstash/server     │  │       @picstash/desktop-app     │  │
│  │    ─────────────────    │  │       ─────────────────         │  │
│  │    Fastify HTTP Server  │  │       Tauri App                 │  │
│  │    Routes, Plugins      │  │       Rust Backend              │  │
│  └─────────────────────────┘  │       Local Storage Adapter     │  │
│                               └─────────────────────────────────┘  │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                   @picstash/web-client                       │   │
│  │  ─────────────────────────────────────────────────────────   │   │
│  │  React + Vite + Mantine（両方のバックエンドから利用）          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Desktop App 構成

```
┌─────────────────────────────────────────────────────────────┐
│                    Tauri Desktop App                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────────────────────┐ │
│  │  Rust Backend   │    │      Web Frontend (React)       │ │
│  │  ─────────────  │    │      ─────────────────────      │ │
│  │  Tauri Commands │◄──►│      @picstash/web-client       │ │
│  │  File System    │    │      Vite + Mantine             │ │
│  └────────┬────────┘    │      TanStack Query             │ │
│           │             └─────────────────────────────────┘ │
│           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                   @picstash/core                         ││
│  │  Repository │ Service │ AI │ Database                    ││
│  └─────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐│
│  │                   Local Storage                         ││
│  │  SQLite DB │ Images │ Thumbnails │ Embeddings           ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

## 進捗

- 2026-01-25: プロジェクト開始

## メモ

- T0（コアロジック分離）が全体の基盤となる重要タスク
- 既存の Fastify サーバーは Web 版で引き続き使用
- デスクトップ版では `@picstash/core` を直接利用
- 既存の AI 処理（@huggingface/transformers）はそのまま利用
- ストレージ抽象化により、将来的にクラウド版との切り替えも容易に
