# CI カバレッジチェック機能追加

## 目的・ゴール

- CI パイプラインにテストカバレッジの閾値チェックとレポート機能を追加
- PR でカバレッジの変化を可視化
- コード品質の定量的指標を導入

## 実装方針

### 1. ファイルごとのカバレッジ閾値チェック

**グローバル閾値ではなく、ファイルごとの閾値チェックを採用:**

- テストピラミッドを遵守しやすい
- 新規ファイルには必ずテストが必要になる
- 既存のテストなしファイルは除外リストで管理

### 2. Vitest カバレッジ設定

```typescript
coverage: {
  thresholds: {
    perFile: true,        // ファイルごとにチェック
    lines: 80,
    branches: 80,
    functions: 80,
    statements: 80,
  },
  // 現状テストがないファイルは除外
  exclude: [
    'src/index.ts',
    'src/features/**/*.tsx',  // 段階的に有効化
    // ...
  ],
}
```

### 3. 段階的な有効化

1. 初期: 既存ファイルを除外リストに追加
2. 新規ファイル: テスト必須
3. 既存ファイル: テスト追加時に除外リストから削除

### 4. CI ワークフローの更新

- `ci-test.yml` にカバレッジ収集を追加
- 閾値未達時に CI を失敗させる
- カバレッジレポートをアーティファクトとして保存

## 技術選定

| 項目 | 選択 | 理由 |
|------|------|------|
| カバレッジツール | Vitest + v8 | 既に設定済み |
| レポーター | text + html + lcov | CLI 出力とローカル確認用 |
| 閾値方式 | perFile | テストピラミッド遵守、新規ファイルにテスト強制 |
| 外部サービス | 使用しない | シンプルな構成を維持 |

## 完了条件

- [x] Vitest カバレッジ設定にファイルごとの閾値を追加
- [x] 現状テストなしファイルを除外リストに追加
- [x] CI でカバレッジを収集・チェック
- [x] 閾値未達時に CI が失敗すること
- [x] カバレッジレポートがアーティファクトとして保存されること

## 作業ログ

- 2026/01/24: タスク開始、方針をファイルごとの閾値チェックに変更
