# タスク 4-1: 画像埋め込みベクトル生成

## 目的・ゴール

AI機能（自動属性推薦、自動説明生成、類似画像検出、重複検出）の基盤となる画像埋め込みベクトル生成機能を実装する。

## 提供価値

- 画像をベクトル空間に埋め込み、後続のAI機能で活用できるようになる
- 類似画像検索の基盤が整う

## 実装方針

### 技術選定

1. **埋め込みモデル**: CLIP（Contrastive Language-Image Pre-Training）
   - 画像とテキストの両方を同じベクトル空間に埋め込める
   - 後続の自動属性推薦（テキストとの類似度計算）に適している
   - JavaScript/TypeScript で利用可能な実装を検討

2. **ベクトルストレージ**: sqlite-vec
   - SQLite 拡張として動作
   - 既存の SQLite インフラと統合しやすい
   - ベクトル検索（kNN）をサポート

### 実装範囲

1. **DB スキーマ拡張**
   - Image テーブルに embedding カラム（BLOB）を追加
   - sqlite-vec のインデックス設定

2. **埋め込み生成サービス**
   - CLIP モデルを使用した画像 → ベクトル変換
   - 非同期処理（画像アップロード時にバックグラウンドで生成）

3. **API エンドポイント**
   - 埋め込み生成状況の確認
   - 手動での埋め込み再生成トリガー

4. **既存画像の一括埋め込み生成**
   - マイグレーションまたは管理コマンドで既存画像を処理

## 完了条件

- [x] 画像アップロード時に埋め込みベクトルが生成される
- [x] 既存画像に対して一括で埋め込みを生成できる
- [x] sqlite-vec でベクトル検索ができる状態になる
- [x] テストが通る
- [x] PR 作成完了 (#27)

## 技術調査メモ

### JavaScript での CLIP 実装オプション

1. **@xenova/transformers** (Transformers.js)
   - HuggingFace の transformers を JavaScript で実行
   - ONNX ランタイムベース
   - ブラウザ・Node.js 両対応

2. **外部 API 呼び出し**
   - OpenAI CLIP API（有料）
   - 自前の Python サービス

### sqlite-vec 導入

- better-sqlite3 と組み合わせて使用
- `vec_f32` 型でベクトルを格納
- `vec_distance_cosine` で類似度計算

## 作業ログ

<!-- 作業の進捗をここに記録 -->

