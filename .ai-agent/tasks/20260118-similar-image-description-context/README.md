# 類似画像の説明を説明生成に反映

## 目的・ゴール

画像の説明を自動生成する際に、類似画像の既存の説明を参考情報として活用することで、より文脈に沿った適切な説明文を生成できるようにする。

## 背景

現在の説明生成は画像単体を見て説明を生成しているため、同じシリーズやキャラクターの画像でも説明の一貫性がない。類似画像に既に説明がついている場合、それを参考にすることでより適切な説明が生成できる可能性がある。

## 実装方針

### アプローチ

説明生成時に以下のフローを追加:

1. 対象画像の埋め込みベクトルを取得
2. 類似画像を検索（上位N件）
3. 類似画像のうち説明がある画像を抽出
4. それらの説明を参考情報としてプロンプトに含める
5. LLMに説明生成を依頼

### 技術的詳細

#### 既存の実装

- `CaptionService.generateFromFile()` - Florence-2で画像キャプション生成
- `EmbeddingRepository.findSimilar()` - 類似画像検索

#### 変更点

1. **API変更**: `/api/images/:id/generate-description`
   - 類似画像の説明を取得するロジックを追加
   - 既存の説明がある場合はそれらをコンテキストとして利用

2. **CaptionService拡張**
   - `generateFromFile()` にオプショナルな `context` パラメータを追加
   - コンテキストがある場合は、それを考慮した説明生成を行う

3. **LLM活用**
   - Florence-2の生成結果 + 類似画像の説明を組み合わせ
   - Ollama等のLLMで最終的な説明を生成
   - または翻訳時にコンテキストを考慮

### フロー

```
POST /api/images/:id/generate-description
  ↓
1. 画像の埋め込みベクトル取得
  ↓
2. findSimilar() で類似画像取得（上位5件）
  ↓
3. 類似画像の説明を取得（descriptionがあるもの）
  ↓
4. Florence-2でキャプション生成
  ↓
5. 類似画像の説明をコンテキストとして、最終説明を生成
  ↓
6. 日本語説明を返却
```

### 考慮事項

- 類似画像に説明がない場合は従来通りの生成
- 類似度が低い画像の説明は参考にしない（閾値設定）
- 類似画像の説明が不適切な場合の影響を最小化
- パフォーマンス: 類似画像検索は既存の高速な実装を活用

## 完了条件

- [ ] 説明生成時に類似画像の説明を参考にできる
- [ ] 類似画像に説明がない場合は従来通り動作する
- [ ] 型チェック・lintが通る

## 作業ログ

### 2026-01-18

- タスク開始
