# タスク 4-5: 重複画像検出

## 目的・ゴール

画像の埋め込みベクトルを使用して、ライブラリ内の重複画像（同一または非常に類似した画像）を検出・整理する機能を実装する。

## 提供価値

- 重複した画像を発見して整理できる
- ストレージの無駄を削減できる
- ライブラリをクリーンに保てる

## 現状分析

### 既存の類似画像検索機能 (4-4)

- `GET /api/images/:id/similar` - 指定画像に類似した画像を取得
- `EmbeddingRepository.findSimilar()` - sqlite-vec による kNN 検索
- `SimilarImagesSection` - 画像詳細画面に類似画像を表示

### 重複検出と類似検索の違い

| 観点 | 類似画像 (4-4) | 重複画像 (4-5) |
|------|---------------|---------------|
| 目的 | 関連コンテンツの発見 | 不要なコピーの整理 |
| しきい値 | 緩い（類似度で表示） | 厳しい（重複判定） |
| 起点 | 特定の画像から | ライブラリ全体 |
| 結果 | 類似度スコア付きリスト | 重複グループのリスト |
| アクション | 詳細画面への遷移 | 削除・マージの判断 |

## 実装方針

### 重複判定ロジック

1. **距離しきい値**: 埋め込みベクトル間の距離が非常に小さい場合を「重複」と判定
   - 類似検索: distance で類似度を表示（しきい値なし）
   - 重複検出: distance < 0.1 を重複と判定（調整可能）

2. **グルーピング**: 重複画像をグループ化して返す
   - グループ内で最初にアップロードされた画像を「オリジナル」として扱う

### バックエンド

1. **API エンドポイント**
   - `GET /api/images/duplicates` - 重複グループ一覧を取得
   - クエリパラメータ:
     - `threshold`: 重複判定のしきい値（デフォルト: 0.1）

2. **レスポンス形式**
   ```typescript
   {
     groups: {
       original: {
         id: string;
         filename: string;
         thumbnailPath: string;
         createdAt: string;
       };
       duplicates: {
         id: string;
         filename: string;
         thumbnailPath: string;
         createdAt: string;
         distance: number;
       }[];
     }[];
     totalGroups: number;
     totalDuplicates: number;
   }
   ```

### フロントエンド

1. **重複画像管理ページ**
   - ギャラリーメニューまたはツールバーからアクセス
   - 重複グループをカード形式で表示
   - グループごとに「オリジナル」と「重複」を視覚的に区別

2. **一括操作**
   - 重複画像の選択削除
   - 全グループの重複を一括削除（オリジナル以外）

## 完了条件

- [x] ライブラリ全体から重複画像グループを検出できる API がある
- [x] 重複判定のしきい値を調整できる
- [x] 重複画像管理ページがある
- [x] 重複画像を選択して削除できる
- [x] テストが通る

## 作業ログ

### 2026-01-17

1. **バックエンド実装**
   - `EmbeddingRepository` に `getAllImageIds()` メソッド追加
   - `application/duplicate-detection/find-duplicates.ts` 作成
     - Union-Find でグループ化
     - しきい値（デフォルト 0.1）で重複判定
   - `GET /api/images/duplicates` エンドポイント追加

2. **フロントエンド実装**
   - `features/duplicates` フィーチャー作成
   - `DuplicatesPage` - 重複画像管理ページ
   - `DuplicateGroupCard` - グループ表示カード
   - ナビゲーションにリンク追加

3. **動作確認**
   - 全 129 テストパス
   - ブラウザで重複検出・表示を確認
   - 2グループ・2重複が正常に検出
