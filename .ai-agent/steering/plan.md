# Picstash 実装計画

## 概要

プロダクトを独自の価値を提供するセグメントに分割し、各セグメントを順次実装することで継続的に改善しながら機能を追加していく。

本ドキュメントは **product.md の Phase 1（デスクトップアプリ × 感性マップ体験）** の具体的な実装計画である。

## プロダクト戦略との対応

```
product.md                          plan.md（本ドキュメント）
─────────────────────────────────────────────────────────────────────

Phase 1: デスクトップアプリ    ──→   Phase 1-5 で詳細化
         × 感性マップ体験            ├─ Phase 1: デスクトップアプリ化
                                     ├─ Phase 2: 動画対応
                                     ├─ Phase 3: おすすめ機能拡充（感性マップ）
                                     ├─ Phase 4: メディア取り込み強化
                                     └─ Phase 5: 学習データ活用

Phase 2: ブラウザプラグイン    ──→   product.md 参照（Phase 4 の一部を先行）
Phase 3: クラウド対応          ──→   product.md 参照
Phase 4: モバイル対応          ──→   product.md 参照
```

## ロードマップ概要（Phase 1-5）

```
Phase 1: デスクトップアプリ化 ────────────────────────────────┐
  Electron 化 → ストレージ抽象化 → ローカル保存 → オフライン │
                                                          │
Phase 2: 動画対応           ─────────────────────────────────┤
  動画取り込み → サムネイル生成 → 再生機能 → メタデータ抽出  │
                                                          │
Phase 3: おすすめ機能拡充（感性マップの核心）─────────────────┤
  チャンネル基盤 → 類似画像 → タグ推薦 → 時間軸推薦        │
                                                          │
Phase 4: メディア取り込み強化 ───────────────────────────────┤
  ブラウザ拡張 → 一括取り込み → メタデータ保存 → D&D       │
                                                          │
Phase 5: 学習データ活用      ────────────────────────────────┘
  行動データ収集 → 嗜好モデル → 適応型推薦 → 進化する補完
```

**中長期戦略（Phase 2 以降）については product.md を参照**

---

## Phase 1: デスクトップアプリ化

### 目標
ブラウザなしでネイティブアプリとして動作させ、Eagle からの移行先として選ばれるプロダクトにする。

### セグメント分解

| # | セグメント | 提供価値 | 完了条件 | 状態 |
|---|-----------|---------|----------|------|
| 1-1 | Electron 化 | デスクトップアプリとしてビルド | exe/dmg/AppImage が生成される | 完了 |
| 1-2 | Web アプリ組み込み | 既存 Web アプリをレンダラーとして動作 | web-client がアプリ内で動作 | 完了 |
| 1-3 | ストレージ抽象化 | ローカル/クラウド切り替え可能な基盤 | ストレージアダプタが動作する | 完了 |
| 1-4 | ローカルストレージ対応 | 指定フォルダに画像・DB を保存 | ローカルフォルダへの保存が動作 | 完了 |
| 1-5 | ファイル監視 | 指定フォルダの変更を自動検知 | フォルダ追加で自動インポート | 未着手 |
| 1-6 | オフライン対応 | ネットワークなしで動作 | オフラインで全機能が使える | 未着手 |

### 実装順序

```
1-1 Electron 化 ✅
 ├─ Electron プロジェクトセットアップ
 ├─ メインプロセス: BrowserWindow 作成、セキュリティ設定
 ├─ プリロード: contextBridge による API 公開
 ├─ Electron Builder: パッケージング設定
 └─ E2E テスト環境（Playwright + Electron）
     ↓
1-2 Web アプリ組み込み ✅
 ├─ web-client のレンダラーとしての統合
 ├─ IPC 通信の設計・実装
 └─ 開発時のホットリロード対応
     ↓
1-3 ストレージ抽象化 ✅
 ├─ ストレージインターフェース定義
 ├─ IPC 経由でのファイルシステムアクセス
 └─ 既存コードのリファクタリング
     ↓
1-4 ローカルストレージ対応 ✅
 ├─ ローカルファイルシステムアダプタ
 ├─ SQLite へのマイグレーション対応
 └─ 指定フォルダへの画像・DB 保存
     ↓
1-5 ファイル監視
 ├─ chokidar / fs.watch による監視
 └─ 自動インポートジョブ
     ↓
1-6 オフライン対応
 ├─ AI 解析のローカル実行（Ollama 等）
 └─ オフラインモード切り替え
```

---

## Phase 2: 動画対応

### 目標
画像と同様に動画もライブラリで管理・閲覧できるようにする。

### セグメント分解

| # | セグメント | 提供価値 | 完了条件 |
|---|-----------|---------|----------|
| 2-1 | 動画アップロード | 動画ファイルをサーバに保存できる | mp4/webm/mov のアップロードが成功する |
| 2-2 | サムネイル生成 | 動画から代表フレームを抽出して一覧表示 | サムネイルが生成される |
| 2-3 | 動画再生 | 詳細画面で動画を再生・操作できる | 再生/一時停止/シーク/音量が動作する |
| 2-4 | メタデータ抽出 | 動画の長さ・解像度・コーデックを表示 | 動画情報が詳細画面に表示される |
| 2-5 | 動画 AI 解析（映像） | キーフレームから属性・説明を自動推薦 | 複数フレームを解析して推薦が出る |
| 2-6 | 音声書き起こし | 動画内の音声をテキスト化して検索・解析に活用 | Whisper 等で書き起こしが生成される |

### 実装順序

```
2-1 動画アップロード
 ├─ サーバ: 動画 MIME タイプの受け入れ
 ├─ DB: メディアタイプ（image/video）の区別
 └─ API: アップロードエンドポイント拡張
     ↓
2-2 サムネイル生成
 ├─ アップロード時にサムネイル自動生成
 └─ ギャラリーでの表示（動画アイコン付き）
     ↓
2-3 動画再生
 ├─ 詳細画面に video タグ追加
 ├─ プレイヤー UI（再生/停止/シーク）
 └─ フルスクリーン対応
     ↓
2-4 メタデータ抽出
 ├─ メタデータ取得
 └─ 詳細画面に情報表示
     ↓
2-5 動画 AI 解析（映像）
 ├─ キーフレーム抽出ロジック
 └─ 既存 AI 解析との統合
     ↓
2-6 音声書き起こし
 ├─ 音声トラック抽出
 ├─ ローカル Whisper などで書き起こし
 ├─ 書き起こしテキストの保存・表示
 └─ 書き起こしテキストを説明文・タグ推薦に活用
```

### 動画解析の全体像

```
┌─────────────────────────────────────────────────────────────┐
│                      動画ファイル                           │
│                          │                                  │
│          ┌───────────────┼───────────────┐                  │
│          ▼               ▼               ▼                  │
│    ┌──────────┐    ┌──────────┐    ┌──────────┐            │
│    │ キーフレーム│    │  音声    │    │メタデータ│            │
│    │   抽出    │    │   抽出   │    │  抽出   │            │
│    └─────┬────┘    └─────┬────┘    └─────┬────┘            │
│          ▼               ▼               ▼                  │
│    ┌──────────┐    ┌──────────┐    ┌──────────┐            │
│    │  画像AI  │    │ Whisper  │    │ 長さ/解像度│            │
│    │   解析   │    │ 書き起こし│    │ コーデック│            │
│    └─────┬────┘    └─────┬────┘    └─────┬────┘            │
│          │               │               │                  │
│          └───────────────┼───────────────┘                  │
│                          ▼                                  │
│                 ┌─────────────────┐                        │
│                 │ 統合解析・推薦   │                        │
│                 │ タグ / 説明文   │                        │
│                 └─────────────────┘                        │
└─────────────────────────────────────────────────────────────┘
```

---

## Phase 3: おすすめ機能の拡充（感性マップの核心）

### 目標
**product.md の「感性マップ体験」を実現する最重要フェーズ。**

Apple Music の自動プレイリストのように、複数の切り口で「おすすめチャンネル」を提示し、ユーザーが新しい画像と出会える体験を提供する。

**このフェーズで実現する価値:**
- 似た雰囲気の画像がグループ化される
- 1枚選ぶと芋づる式に関連画像が出てくる
- 「あの雰囲気」「前に見たあれ」で探せる
- 自分の好みを再発見する快感

### おすすめチャンネル例

```
┌─────────────────────────────────────────────────────────────┐
│  🔥 最近のお気に入りに似た画像                              │
│  ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐                      │
│  │   │ │   │ │   │ │   │ │   │ │   │  →                   │
│  └───┘ └───┘ └───┘ └───┘ └───┘ └───┘                      │
├─────────────────────────────────────────────────────────────┤
│  🏷️ 「風景」タグの新着                                     │
│  ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐                      │
│  │   │ │   │ │   │ │   │ │   │ │   │  →                   │
│  └───┘ └───┘ └───┘ └───┘ └───┘ └───┘                      │
├─────────────────────────────────────────────────────────────┤
│  ⏰ しばらく見ていない画像                                  │
│  ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐                      │
│  │   │ │   │ │   │ │   │ │   │ │   │  →                   │
│  └───┘ └───┘ └───┘ └───┘ └───┘ └───┘                      │
└─────────────────────────────────────────────────────────────┘
```

### チャンネル種別

| チャンネル | 説明 | ロジック |
|-----------|------|----------|
| 最近のお気に入りに似た画像 | お気に入りに基づく類似推薦 | 直近のお気に入り画像と類似度が高い画像 |
| よく見るタグの新着 | 閲覧傾向に基づく新着 | 閲覧頻度の高いタグを持つ最近追加された画像 |
| しばらく見ていない画像 | 再発見の促進 | 過去にお気に入りしたが最近閲覧していない画像 |
| このコレクションが好きなら | コレクション間の関連 | 同じタグを共有する別コレクションの画像 |
| ランダムピックアップ | セレンディピティ | ランダムに選ばれた画像（新しい発見用） |
| 季節・時期のおすすめ | 時間軸での推薦 | 撮影日や追加日が同時期の過去画像 |

### セグメント分解

| # | セグメント | 提供価値 | 完了条件 |
|---|-----------|---------|----------|
| 3-1 | チャンネル基盤 | 複数チャンネルを表示する UI/API | チャンネル一覧 API とホーム画面 UI |
| 3-2 | 類似画像検索 | 「似た画像」チャンネルの実現 | 特徴量ベースの類似検索が動作 |
| 3-3 | タグベース推薦 | タグ関連のチャンネル実現 | タグ新着・関連タグ推薦が動作 |
| 3-4 | 時間軸推薦 | 再発見・季節系チャンネル実現 | 閲覧履歴・日付ベースの推薦が動作 |
| 3-5 | チャンネルカスタマイズ | ユーザーがチャンネルを調整 | チャンネルの表示/非表示・並び替え |

### 実装順序

```
3-1 チャンネル基盤
 ├─ チャンネル定義モデル（id, name, type, query）
 ├─ チャンネル一覧 API（GET /api/channels）
 ├─ チャンネル別画像取得 API（GET /api/channels/:id/images）
 └─ ホーム画面 UI（横スクロールカルーセル）
     ↓
3-2 類似画像検索
 ├─ 画像特徴量の抽出（CLIP など）
 ├─ ベクトル DB 導入（pgvector / SQLite-vec）
 ├─ 類似検索 API
 └─ 「お気に入りに似た画像」チャンネル実装
     ↓
3-3 タグベース推薦
 ├─ タグ閲覧頻度の集計
 ├─ タグ共起行列の計算
 ├─ 「よく見るタグの新着」チャンネル
 └─ 「関連タグの画像」チャンネル
     ↓
3-4 時間軸推薦
 ├─ 最終閲覧日の活用
 ├─ 「しばらく見ていない画像」チャンネル
 └─ 「季節のおすすめ」チャンネル
     ↓
3-5 チャンネルカスタマイズ
 ├─ チャンネル表示設定 UI
 ├─ 並び順のカスタマイズ
 └─ ユーザー設定の永続化
```

---

## Phase 4: メディア取り込み強化

### 目標
ブラウザ拡張やドラッグ＆ドロップで、Web 上の画像を簡単に Picstash に取り込めるようにする。Eagle の強みである「Web 画像の簡単保存」に対抗する機能。

### セグメント分解

| # | セグメント | 提供価値 | 完了条件 |
|---|-----------|---------|----------|
| 4-1 | ブラウザ拡張 | 表示中のページの画像を選択して取り込み | Chrome/Firefox 拡張で画像を Picstash に保存できる |
| 4-2 | 一括取り込み | ページ内の全画像を一括でインポート | 複数画像を一度に取り込める |
| 4-3 | メタデータ保存 | 出典 URL・ページタイトル・作者情報の自動取得 | 取り込み時にメタデータが自動付与される |
| 4-4 | ドラッグ＆ドロップ | デスクトップアプリへの直接 D&D | 画像をアプリにドロップして取り込める |

### 実装順序

```
4-1 ブラウザ拡張
 ├─ 拡張の基本構造（manifest, popup, content script）
 ├─ 画像検出・選択 UI
 ├─ Picstash API との連携
 └─ 認証・接続設定
     ↓
4-2 一括取り込み
 ├─ ページ内画像の一覧表示
 ├─ 選択 UI（全選択/個別選択）
 └─ バッチアップロード処理
     ↓
4-3 メタデータ保存
 ├─ 出典 URL の自動取得
 ├─ ページタイトル・OGP 情報の取得
 ├─ 作者情報の抽出（pixiv, Twitter 等のパターン対応）
 └─ メタデータの DB 保存・表示
     ↓
4-4 ドラッグ＆ドロップ
 ├─ デスクトップアプリでの D&D 受け付け
 ├─ URL からの画像取得
 └─ ファイルドロップとの統合
```

---

## Phase 5: 学習データ活用（進化するシステム）

### 目標
ユーザーの行動データと蓄積した画像データをアプリ内で活用し、使えば使うほど推薦精度が向上し、自動補完が賢くなる「進化するシステム」を実現する。

### コンセプト

```
┌─────────────────────────────────────────────────────────────┐
│                    進化のフィードバックループ                │
│                                                             │
│   ユーザー行動                      システム学習            │
│   ┌─────────┐                      ┌─────────┐            │
│   │ 閲覧    │──┐                ┌──│ 嗜好    │            │
│   │ お気に入り│  │    蓄積      │  │ モデル  │            │
│   │ タグ編集 │  │──→ データ ──→│  │ 更新    │            │
│   │ 評価    │  │                │  └─────────┘            │
│   └─────────┘  │                │       │                 │
│        ↑       │                │       ↓                 │
│        │       │                │  ┌─────────┐            │
│        │       └────────────────┘  │ 推薦    │            │
│        │                           │ 自動補完│            │
│        └───────────────────────────│ の改善  │            │
│                                    └─────────┘            │
└─────────────────────────────────────────────────────────────┘
```

### 進化する機能

| 機能 | 現状 | 進化後 |
|------|------|--------|
| タグ推薦 | AI が汎用的に推薦 | ユーザーがよく使うタグを優先的に推薦 |
| 説明文生成 | AI が汎用的に生成 | ユーザーの記述スタイルに近づく |
| おすすめ | 類似度ベース | 行動パターンから好みを予測 |
| 検索 | キーワード一致 | 過去の検索傾向から意図を推測 |

### セグメント分解

| # | セグメント | 提供価値 | 完了条件 |
|---|-----------|---------|----------|
| 5-1 | 行動データ収集基盤 | ユーザー行動を分析可能な形で蓄積 | 閲覧・お気に入り・編集履歴が記録される |
| 5-2 | 嗜好モデル構築 | ユーザーの好みを数値化 | タグ・色・構図などの嗜好スコアが計算される |
| 5-3 | 適応型タグ推薦 | よく使うタグを優先表示 | タグ使用頻度に基づく推薦順序の変化 |
| 5-4 | 適応型説明文生成 | ユーザーの記述スタイルを学習 | 過去の説明文を参考にした生成 |
| 5-5 | フィードバック学習 | 推薦の採用/却下から学習 | 推薦を採用/却下した結果が次回に反映 |

### 実装順序

```
5-1 行動データ収集基盤
 ├─ 行動イベントモデル（view, favorite, edit, search）
 ├─ イベント記録 API / ミドルウェア
 └─ 行動履歴テーブル設計
     ↓
5-2 嗜好モデル構築
 ├─ タグ嗜好スコア計算（使用頻度 × 時間減衰）
 ├─ 色・構図などの視覚的嗜好分析
 └─ 嗜好プロファイルの永続化
     ↓
5-3 適応型タグ推薦
 ├─ AI 推薦 + 嗜好スコアのハイブリッド
 ├─ 推薦順序のパーソナライズ
 └─ 「いつも使うタグ」セクション
     ↓
5-4 適応型説明文生成
 ├─ 過去の説明文のスタイル分析
 ├─ プロンプトへのスタイル情報注入
 └─ 生成文のトーン調整
     ↓
5-5 フィードバック学習
 ├─ 推薦採用/却下の記録
 ├─ 暗黙的フィードバック（クリック、滞在時間）
 └─ 嗜好モデルの継続的更新
```

### 学習に使うデータ

| データ種別 | 収集方法 | 活用先 |
|-----------|---------|--------|
| 閲覧履歴 | 詳細画面表示時に記録 | おすすめチャンネル、再発見 |
| お気に入り | お気に入り追加/削除時 | 嗜好モデル、類似画像推薦 |
| タグ編集 | タグ追加/削除時 | 適応型タグ推薦 |
| 説明文編集 | 説明文保存時 | 説明文スタイル学習 |
| 検索クエリ | 検索実行時 | 検索意図推測 |
| 推薦フィードバック | 推薦画像のクリック/スキップ | 推薦精度向上 |

---

## 中長期戦略（Phase 2 以降）

Phase 1-5 完了後の展開については **product.md のプロダクト戦略** を参照。

```
product.md 戦略ロードマップ
─────────────────────────────────────────────────────────────────────
Phase 2: ブラウザプラグイン × 外部連携・取り込み
Phase 3: クラウド対応 × マルチデバイス同期
Phase 4: モバイル対応 × いつでもどこでも（ポテンシャル最大）
```

**ポイント:**
- Phase 2（ブラウザプラグイン）はキャッシュフローが軽く、Phase 1 の次に着手
- Phase 3（クラウド）は Phase 4（モバイル）の前提条件
- Phase 4（モバイル）はポテンシャル最大だが、依存関係により最後

---

## 各セグメントの進め方

### 基本方針
- **対話的に進める**: 各ステップでユーザーと確認しながら実装
- **早めのフィードバック**: 動くものを早く見せて方向修正
- **小さく作って確認**: 一度に大きく作らず、小さな単位で確認

### イテレーションサイクル

```
1. 計画確認
   - 次に作るものを確認
   - 不明点があれば質問
          ↓
2. 最小実装
   - 動く最小限を実装
   - 完璧を目指さない
          ↓
3. デモ・確認
   - 動作を見せてフィードバックをもらう
   - 方向修正があれば即反映
          ↓
4. 改善・次へ
   - フィードバックを反映
   - 次の機能へ進む
```

### 確認タイミング
- データモデル設計後
- API 実装後（curl などで動作確認）
- UI の骨組み完成後
- 各機能の実装完了後

---

## 優先度まとめ

| Phase | テーマ | 優先度 | 状態 |
|-------|--------|--------|------|
| 1 | デスクトップアプリ | 高 | 進行中（1-1〜1-4 完了） |
| 2 | 動画対応 | 高 | 未着手 |
| 3 | おすすめ機能拡充（感性マップ） | **最高** | 一部実装済み（3-1, 3-2 完了） |
| 4 | メディア取り込み強化 | 中 | 未着手 |
| 5 | 学習データ活用 | 中 | 一部実装済み（5-1 完了: 閲覧履歴・統計） |

**Note:** Phase 3（おすすめ機能拡充）は product.md の「感性マップ体験」の核心であり、最優先で完成させるべき。

### 実装済み機能（Phase 3/5 関連）

- **チャンネル基盤 (3-1)**: ホーム画面におすすめチャンネル UI 実装済み
- **類似画像検索 (3-2)**: CLIP 埋め込み + sqlite-vec による類似検索実装済み
- **閲覧履歴 (5-1)**: 閲覧履歴の記録・表示、統計ダッシュボード実装済み
- **推薦コンバージョン**: 推薦画像のクリック記録実装済み

### 中長期（Phase 2 以降）

product.md のプロダクト戦略を参照。
